<ion-content [scrollY]="false">
  <div class="page-top">
    <div class="top-row">
      <h1 class="page-title">Mapa</h1>
      <div class="top-actions">
        <ion-button fill="clear" size="small" (click)="fitAllStores()">
          <ion-icon name="expand-outline" slot="icon-only"></ion-icon>
        </ion-button>
        <ion-button fill="clear" size="small" (click)="centerOnUser()">
          <ion-icon name="locate-outline" slot="icon-only"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Filter chips -->
    <div class="filter-row">
      <button
        class="filter-chip"
        *ngFor="let filter of storeFilters"
        [class.active]="filter.active"
        [attr.aria-pressed]="filter.active"
        [attr.aria-label]="'Filtrar por ' + filter.label"
        (click)="toggleFilter(filter)"
      >
        <ion-icon [name]="filter.icon"></ion-icon>
        {{ filter.label }}
      </button>
    </div>
  </div>

  <!-- Map -->
  <div class="map-container" id="preci-map"></div>

  <!-- Location error banner -->
  <div class="location-error" *ngIf="locationError">
    <ion-icon name="warning-outline"></ion-icon>
    <span>{{ locationError }}</span>
  </div>

  <!-- Store count badge -->
  <div class="store-count" *ngIf="stores.length > 0 && !selectedStore" [class.shifted]="locationError">
    {{ stores.length }} tiendas
  </div>

  <!-- ═══ STORE DETAIL CARD — slides up when a marker is tapped ═══ -->
  <div class="store-detail" *ngIf="selectedStore" (click)="$event.stopPropagation()">
    <button class="store-detail__close" (click)="closeStoreDetail()" aria-label="Cerrar">
      <ion-icon name="close-outline"></ion-icon>
    </button>

    <div class="store-detail__header">
      <div
        class="store-detail__icon"
        [ngClass]="getChainClass(selectedStore)"
        [style.background]="getChainBg(selectedStore)"
      >
        <span *ngIf="getChainLabel(selectedStore)" class="chain-initial">{{ getChainLabel(selectedStore) }}</span>
        <ion-icon *ngIf="!getChainLabel(selectedStore)" [name]="getStoreIcon(selectedStore.type)"></ion-icon>
      </div>
      <div class="store-detail__info">
        <h3 class="store-detail__name">{{ selectedStore.name }}</h3>
        <div class="store-detail__badges">
          <span class="store-detail__type-badge">{{ storeTypeLabel(selectedStore.type) }}</span>
          <span class="store-detail__distance" *ngIf="distanceToStore(selectedStore)">
            <ion-icon name="navigate-outline"></ion-icon>
            {{ distanceToStore(selectedStore) }}
          </span>
        </div>
      </div>
    </div>

    <div class="store-detail__meta" *ngIf="selectedStore.address || selectedStore.district">
      <ion-icon name="location-outline"></ion-icon>
      <span>{{ selectedStore.address || selectedStore.district }}</span>
    </div>

    <div class="store-detail__actions">
      <button class="store-detail__action-btn store-detail__action-btn--primary" (click)="getDirections(selectedStore)">
        <ion-icon name="navigate-outline"></ion-icon>
        Como llegar
      </button>
      <button class="store-detail__action-btn" (click)="closeStoreDetail()">
        <ion-icon name="close-circle-outline"></ion-icon>
        Cerrar
      </button>
    </div>
  </div>

  <!-- Bottom store list (draggable sheet style) -->
  <div class="store-sheet" [class.hidden]="selectedStore">
    <div class="sheet-handle"></div>
    <div class="sheet-header">
      <span class="preci-section-label">Cerca de ti</span>
      <button class="add-store-btn" (click)="openSuggestStore()" aria-label="Agregar tienda">
        <ion-icon name="add-circle-outline"></ion-icon>
        <span>Agregar</span>
      </button>
    </div>

    <div *ngIf="isLoading" class="loading-stores">
      <div class="skeleton-store" *ngFor="let i of [1,2,3]">
        <div class="skeleton-icon preci-skeleton"></div>
        <div class="skeleton-info">
          <div class="preci-skeleton" style="width: 55%; height: 14px;"></div>
          <div class="preci-skeleton" style="width: 35%; height: 11px; margin-top: 6px;"></div>
        </div>
      </div>
    </div>

    <div *ngIf="stores.length > 0 && !isLoading" class="store-cards">
      <div class="store-card" *ngFor="let store of stores" (click)="goToStore(store)">
        <div
          class="store-icon-container"
          [ngClass]="getChainClass(store)"
          [style.background]="getChainBg(store)"
        >
          <span *ngIf="getChainLabel(store)" class="chain-initial">{{ getChainLabel(store) }}</span>
          <ion-icon *ngIf="!getChainLabel(store)" [name]="getStoreIcon(store.type)"></ion-icon>
        </div>
        <div class="store-info">
          <h4 class="store-name">{{ store.name }}</h4>
          <p class="store-meta">{{ storeMetaLabel(store) }}</p>
        </div>
        <span class="store-distance">{{ distanceToStore(store) }}</span>
        <ion-icon name="chevron-forward-outline" class="store-chevron"></ion-icon>
      </div>
    </div>

    <div *ngIf="stores.length === 0 && !isLoading" class="no-stores-state">
      <ion-icon name="location-outline"></ion-icon>
      <p>No hay tiendas en esta zona</p>
      <button class="add-store-btn" (click)="openSuggestStore()">
        <ion-icon name="add-circle-outline"></ion-icon>
        <span>Agregar una</span>
      </button>
    </div>
  </div>
</ion-content>
