<ion-header class="ion-no-border">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/search" text=""></ion-back-button>
    </ion-buttons>
    <ion-title>Comparar precios</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content>

  <!-- ERROR STATE -->
  <div *ngIf="hasError && !isLoadingProduct" class="error-state">
    <ion-icon name="alert-circle-outline" class="error-icon"></ion-icon>
    <h3>No se pudo cargar el producto</h3>
    <p>Revisa tu conexion e intenta nuevamente</p>
    <ion-button fill="outline" color="primary" (click)="goBack()">
      Volver
    </ion-button>
  </div>

  <ng-container *ngIf="!hasError">

    <!-- ====================================================================
         PRODUCT HEADER — compact horizontal layout
         ==================================================================== -->
    <div class="product-header">
      <div class="product-header__image">
        <img
          *ngIf="product?.imageUrl; else imgPlaceholder"
          [src]="product!.imageUrl"
          [alt]="product!.name"
        />
        <ng-template #imgPlaceholder>
          <ion-icon name="cube-outline"></ion-icon>
        </ng-template>
      </div>

      <div class="product-header__info">
        <ng-container *ngIf="isLoadingProduct; else headerInfo">
          <div class="preci-skeleton" style="width: 80%; height: 18px;"></div>
          <div class="preci-skeleton" style="width: 50%; height: 14px; margin-top: 6px;"></div>
        </ng-container>
        <ng-template #headerInfo>
          <h1 class="product-header__name">{{ product?.name }}</h1>
          <p class="product-header__meta">
            <span *ngIf="product?.brand">{{ product!.brand }}</span>
            <span *ngIf="product?.brand && product?.unitSize"> · </span>
            <span *ngIf="product?.unitSize">{{ product!.unitSize }}{{ product?.unit }}</span>
          </p>
        </ng-template>
      </div>

      <!-- Best price highlight -->
      <div class="product-header__price" *ngIf="!isLoadingPrices && bestPrice">
        <span class="from-label">desde</span>
        <div class="from-price">
          <span class="from-currency">S/</span>
          <span class="from-amount">{{ bestPrice.price | number:'1.2-2' }}</span>
        </div>
      </div>
    </div>

    <!-- ====================================================================
         SAVINGS BANNER — only when there's a price spread
         ==================================================================== -->
    <div class="savings-banner" *ngIf="!isLoadingPrices && prices.length >= 2 && extraCost(prices[prices.length - 1])">
      <ion-icon name="trending-down-outline"></ion-icon>
      <span>
        Ahorras hasta <strong>S/{{ extraCost(prices[prices.length - 1]) | number:'1.2-2' }}</strong>
        comprando en <strong>{{ cleanStoreName(bestPrice!.storeName) }}</strong>
      </span>
    </div>

    <!-- ====================================================================
         STORE COMPARISON — main section
         ==================================================================== -->
    <div class="comparison-section" *ngIf="!isLoadingPrices && prices.length > 0">

      <h2 class="comparison-title">
        Precio por tienda
        <span class="comparison-count">{{ prices.length }} tienda{{ prices.length > 1 ? 's' : '' }}</span>
      </h2>

      <div class="store-cards">
        <div
          *ngFor="let entry of prices; let i = index; let first = first; let last = last"
          class="store-card"
          [class.store-card--best]="first"
          [class.store-card--worst]="last && prices.length > 1"
        >

          <!-- Store identity -->
          <div class="store-card__left">
            <div class="store-card__avatar" [class.store-card__avatar--best]="first">
              {{ storeInitial(entry.storeName) }}
            </div>
            <div class="store-card__info">
              <span class="store-card__name">{{ cleanStoreName(entry.storeName) }}</span>
              <span class="store-card__meta">
                {{ timeAgo(entry.reportedAt) }}
              </span>
            </div>
          </div>

          <!-- Price + badges -->
          <div class="store-card__right">
            <div class="store-card__badges">
              <span class="badge-best" *ngIf="first && prices.length > 1">Mejor precio</span>
              <span class="badge-sale" *ngIf="entry.isOnSale">OFERTA</span>
            </div>
            <div class="store-card__price" [class.store-card__price--best]="first" [class.store-card__price--worst]="last && prices.length > 1">
              <span class="sc-currency">S/</span>
              <span class="sc-amount">{{ entry.price | number:'1.2-2' }}</span>
            </div>
            <span class="store-card__diff" *ngIf="extraCost(entry) as extra">
              +S/{{ extra | number:'1.2-2' }}
            </span>
          </div>

          <!-- Comparison bar -->
          <div class="store-card__bar">
            <div class="store-card__bar-fill"
                 [style.width.%]="storeBarWidth(entry)"
                 [class.bar--best]="first"
                 [class.bar--worst]="last && prices.length > 1">
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- LOADING SKELETON -->
    <div class="comparison-section" *ngIf="isLoadingPrices">
      <h2 class="comparison-title">Precio por tienda</h2>
      <div class="store-cards">
        <div class="store-card-skeleton" *ngFor="let i of [1,2,3,4]">
          <div class="preci-skeleton" style="width: 40px; height: 40px; border-radius: 10px; flex-shrink:0;"></div>
          <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
            <div class="preci-skeleton" style="height: 14px; width: 55%;"></div>
            <div class="preci-skeleton" style="height: 12px; width: 35%;"></div>
          </div>
          <div class="preci-skeleton" style="height: 28px; width: 72px; border-radius: 8px;"></div>
        </div>
      </div>
    </div>

    <!-- NO PRICES STATE -->
    <div class="comparison-section" *ngIf="!isLoadingPrices && prices.length === 0">
      <div class="no-prices-card">
        <ion-icon name="pricetag-outline" class="no-prices-icon"></ion-icon>
        <p class="no-prices-title">Sin precios disponibles</p>
        <p class="no-prices-sub">Este producto aun no tiene precios registrados</p>
      </div>
    </div>

  </ng-container>

</ion-content>

<ion-footer class="ion-no-border" *ngIf="!hasError && product">
  <ion-toolbar>
    <div class="report-btn-wrapper">
      <ion-button expand="block" color="primary" (click)="navigateToReportPrice()">
        <ion-icon name="pricetag-outline" slot="start"></ion-icon>
        Reportar precio
      </ion-button>
    </div>
  </ion-toolbar>
</ion-footer>
